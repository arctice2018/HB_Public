第 5 课
========================================================

### 多变量数据
注释：

***

### 年龄标记为彩色的自我感知关注量
注释：

***
```{r}
library(ggplot2)
library(dplyr)
library(reshape2)
library(tidyr)
```

### 第三个定性变量
注释：
1. 使用group_by()函数，不需要再使用ungroup()函数，这是dplyr0.5.0版本之前的问题。参考
http://xukuang.github.io/blog/2014/12/group-by-and-ungroup-function-in-R/
2. 从执行结果来看，summarise()函数好像执行了arrange()函数的排序功能，除非需要指定特定的排序变量，否则不必显性执行
arrange()函数。
```{r}
group_by_age_gender <- group_by(subset(df,!is.na(gender)),age,gender)
df.fc_by_age_gender <- summarise(group_by_age_gender,
                                  mean_friend_count = mean(friend_count),
                                  median_friend_count = median(friend_count),
                                  n = n())
head(df.fc_by_age_gender)
```

```{r Third Qualitative Variable}
ggplot(aes(x = gender, y = age),
       data = subset(pf, !is.na(gender))) + 
  geom_boxplot(outlier.colour = I('red')) +
  stat_summary(fun = mean,shape = 4)
```
```{r}
ggplot(aes(x = age,y = friend_count,color = gender),data = subset(df,!is.na(gender))) +
  geom_line(stat = 'summary',fun= median)
```
上面的代码，发现可以在ggplot()图层中aes中传入color，也可以在geom_line中传入
下面代码是较为简洁的代码。
**R语言的函数不严谨，相关函数没有规定参数有哪些，不像python，而是不用管帮助文档的规定，只要传入的参数可以使用就可以，比如，上面代码中，geom_line(),没有fun参数，你传入了就识别了。**
```{r}
ggplot(aes(x = age,y = friend_count),data = subset(df,!is.na(gender))) +
  stat_summary(geom = 'line',fun = median,aes(color = gender))
```

***

### 绘制条件总结
注释：

```{r Plotting Conditional Summaries}
# 使用dplyr包，summaries,group_by生成的结果来绘制如上两个图形
ggplot(aes(x = age,y = median_friend_count),data = df.fc_by_age_gender) +
  geom_line(aes(color =gender))
```


### 改变数据
注释：

1.将long格式的数据转换为wide格式的数据，如果处理的是dataframe，那么使用dcast,也就是说函数的第一个字母表示待处理的数据类型，而对与处理的是array类型的数据，那么使用acast函数。
2.'~'符号左边的列名是在返回值中出现的列，而符号右边的列名是需要展开的，将其中的值（male和female）作为返回值的新的列名。

```{r}
df.fc_by_age_gender.wide <- dcast(df.fc_by_age_gender,age~gender,value.var = 'median_friend_count')
head(pf.fc_by_age_gender.wide)
```
The linetype parameter can take the values 0-6:
0 = blank, 1 = solid, 2 = dashed
3 = dotted, 4 = dotdash, 5 = longdash
6 = twodash
***

### 比率图
注释：

```{r Ratio Plot}
ggplot(aes(x = age,y = female/male),data = pf.fc_by_age_gender.wide) +
  geom_line() +
  geom_hline(yintercept = 1,alpha=0.5,linetype = 2)
```

***

### 第三个定性变量
注释：

```{r Third Quantitative Variable}

df$year_joined <- floor(2014-df$tenure/365)
summary(df$year_joined)
```

***

### 减少一个变量
注释：

```{r Cut a Variable}
df$year_joined.cut<-cut(df$year_joined,c(2004,2009,2011,2012,2014))
table(df$year_joined.cut)
```

***

### 同时绘制
注释：

```{r Plotting it All Together}
ggplot(aes(x = age,y = friend_count),data = subset(df,!is.na(year_joined.cut))) +
  stat_summary(aes(color = year_joined.cut),geom = 'line',fun =mean)
```

***

### 绘制总平均值
注释：

```{r Plot the Grand Mean}
ggplot(aes(x = age,y = friend_count),data = subset(df,!is.na(year_joined.cut))) +
  stat_summary(aes(color = year_joined.cut),geom = 'line',fun = mean) +
  stat_summary(fun=mean,linetype =2,geom='line')
  #geom_line(stat = 'summary',fun =mean,linetype =2)
```

***

### 交友率
注释：

```{r Friending Rate}
with(subset(df,tenure >=1),summary(friend_count/tenure))
```

***

### 开始交友
注释：

交友率是什么？0.6096

最大交友率是什么？417

```{r Friendships Initiated}
ggplot(aes(x = tenure,y = friendships_initiated/tenure),data = subset(df,tenure>=1)) +
  geom_line(aes(color = year_joined.cut),stat = 'summary',fun=mean)
```

***

### 再次访问方差权衡
注释：

```{r Bias-Variance Tradeoff Revisited}

ggplot(aes(x = tenure, y = friendships_initiated / tenure),
       data = subset(df, tenure >= 1)) +
  geom_line(aes(color = year_joined.cut),
            stat = 'summary',
            fun= mean)

ggplot(aes(x = 7 * round(tenure / 7), y = friendships_initiated / tenure),
       data = subset(df, tenure > 0)) +
  geom_line(aes(color = year_joined.cut),
            stat = "summary",
            fun = mean)

ggplot(aes(x = 30 * round(tenure / 30), y = friendships_initiated / tenure),
       data = subset(df, tenure > 0)) +
  geom_line(aes(color = year_joined.cut),
            stat = "summary",
            fun= mean)

ggplot(aes(x = 90 * round(tenure / 90), y = friendships_initiated / tenure),
       data = subset(df, tenure > 0)) +
  geom_line(aes(color = year_joined.cut),
            stat = "summary",
            fun = mean)

```
```{r}
ggplot(aes(x = tenure, y = friendships_initiated / tenure),
       data = subset(df, tenure >= 1)) +
  geom_smooth(aes(color = year_joined.cut))

```

***

### Sean 对 NFL 粉丝情绪的研究
注释：

***

###  Yogurt 数据集简介
注释：
```{r}
yo <-read.csv('yogurt.csv')
str(yo)
yo$id <- factor(yo$id)
str(yo)
```

***

### 再次访问直方图
注释：

```{r Histograms Revisited}
ggplot(aes(x = price),data = yo) +
  geom_histogram(fill = I('orange'),color = I('black'))
```

***

### 购买数量
注释：使用transform函数用来创建新的变量

```{r Number of Purchases}
yo <- transform(yo,all.purchase = strawberry+ blueberry + pina.colada + plain + mixed.berry)
summary(yo$all.purchase)
```

***

### 一段时期的价格
注释：

```{r Prices over Time}
ggplot(aes(x = time,y = price),data = yo) +
  geom_point(alpha =.05,position = position_jitter(),shape = 21,color =I('orange'))
```

***

### 抽样观察
注释：

***

### 观察家庭的样本
###### 只有factor类型的variable可以使用levels函数，获取其中的levels。引入第三变量，可以使用颜色表示，也可以使用形状的大小来表示，相应的，分别对应的参数是color,size,可以使用aes函数进行包裹，并送入ggplot函数，或者geom_point等图形函数中使用。
```{r Looking at Sample of Households}
set.seed(4320)
sample.ids <- sample(levels(yo$id),16)
ggplot(aes(x = time,y = price),data = subset(yo,id%in%sample.ids)) +
  geom_line() +
  geom_point(aes(size=all.purchase),shape= 1)+
  facet_wrap(~id)
```

***

### 交叉分组数据的缺点
注释：

***

### 许多变量
注释：

***

### 散点图矩阵
注释：
数值型变量产生散点图，而分类变量在其中显示的是直方图和箱型图
参数axisLabels = 'internal'，用来设置变量标签的位置，默认是在图形的四周显示。

```{r}
library(GGally)
theme_set(theme_minimal(20))
df_subset <- df[ , c(2:7)]
ggpairs(df_subset[sample.int(nrow(df_subset),1000),],axisLabels = 'internal')
```

***

### 更多变量
注释：

***

### 热点图
注释：

```{r}
nci <- read.table("nci.tsv")
colnames(nci) <- c(1:64)
```

```{r}
nci.long.samp <- melt(as.matrix(nci[1:200,]))
names(nci.long.samp) <- c("gene", "case", "value")
head(nci.long.samp)

ggplot(aes(y = gene, x = case, fill = value),
  data = nci.long.samp) +
  geom_tile() +
  scale_fill_gradientn(colours = colorRampPalette(c("blue", "red"))(100))
```

***

### 分析三个及三个以上变量
思考：

***

点击 **KnitHTML** 查看你的成果和这节课的 html 页面、
答案和注释！
